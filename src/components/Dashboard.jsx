import React, { useEffect, useState } from 'react'\nimport { fetchSheetValues, appendToSheet } from '../utils/googleSheets'\nimport OrderForm from './OrderForm'\nimport { Chart, BarController, BarElement, CategoryScale, LinearScale, Tooltip, Legend } from 'chart.js'\n\nChart.register(BarController, BarElement, CategoryScale, LinearScale, Tooltip, Legend)\n\nexport default function Dashboard(){\n  const [sheetId, setSheetId] = useState('')\n  const [rows, setRows] = useState([])\n  const [loading, setLoading] = useState(false)\n\n  useEffect(()=>{\n    if(!sheetId) return\n    load()\n  }, [sheetId])\n\n  async function load(){\n    setLoading(true)\n    try{\n      const data = await fetchSheetValues(sheetId)\n      setRows(data)\n    }catch(err){\n      console.error(err)\n      alert('Error leyendo Google Sheets. Revisa consola y credenciales.')\n    }finally{ setLoading(false) }\n  }\n\n  function computeMetrics(rows){\n    const total = rows.length\n    const now = new Date();\n    const month = now.getMonth();\n    const year = now.getFullYear();\n    const failures = rows.filter(r=>{ const d=new Date(r[0]); return d.getMonth()===month && d.getFullYear()===year && (r[4]||'').toLowerCase()==='failed' }).length\n    const byProvider = {}\n    rows.forEach(r=>{ const p=r[1]||'—'; byProvider[p]=(byProvider[p]||0)+1 })\n    const providers = Object.entries(byProvider).sort((a,b)=>b[1]-a[1])\n    const compliance = Object.fromEntries(Object.keys(byProvider).map(p=>[p, Math.round(Math.random()*100)])) // placeholder for % cumplimiento\n    const upcoming = rows.filter(r=>{ const d=new Date(r[0]); return d >= new Date() && (r[4]||'').toLowerCase()!=='delivered' }).slice(0,10)\n    return { total, failures, providers, compliance, upcoming }\n  }\n\n  const metrics = computeMetrics(rows)\n\n  return (\n    <div className="dashboard">\n      <section className="controls">\n        <div>\n          <input placeholder="Spreadsheet ID" value={sheetId} onChange={e=>setSheetId(e.target.value)} />\n          <button onClick={load} disabled={!sheetId}>Cargar</button>\n        </div>\n      </section>\n\n      <section className="metrics-row">\n        <div className="metric-card">\n          <h3>Total pedidos</h3>\n          <div className="metric-value">{metrics.total}</div>\n        </div>\n        <div className="metric-card">\n          <h3>Fallos este mes</h3>\n          <div className="metric-value">{metrics.failures}</div>\n        </div>\n      </section>\n\n      <section className="charts-row">\n        <div className="chart-card">\n          <h3>Top proveedores por pedidos</h3>\n          <canvas id="providersChart" />\n        </div>\n\n        <div className="list-card">\n          <h3>Próximos pedidos</h3>\n          <ul>\n            {metrics.upcoming.map((r,i)=>(<li key={i}>{r[0]} — {r[1]} — {r[2]} x{r[3]} ({r[4]})</li>))}\n          </ul>\n        </div>\n      </section>\n\n      <section className="form-section">\n        <OrderForm onSubmit={async(order)=>{\n          try{\n            await appendToSheet(sheetId, order)\n            await load()\n            alert('Pedido enviado')\n          }catch(err){ console.error(err); alert('Error al enviar pedido') }\n        }} />\n      </section>\n    </div>\n  )\n}